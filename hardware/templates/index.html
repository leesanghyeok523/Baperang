<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WEBCAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @font-face {
        font-family: "CustomFont";
        src: url("{{ url_for("static", filename="fonts/Paperlogy-4Regular.ttf") }}")
          format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      .font-custom {
        font-family: "CustomFont", sans-serif;
      }

      .spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
      }

      .spinner {
        width: 120px;
        height: 120px;
        border: 16px solid #f3f3f3;
        border-top: 16px solid #96c059;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div
      class="min-h-screen w-full"
      style="
        background-image: url('{{ url_for('static', filename='image/background/background_main.png') }}');
        background-size: cover;
        background-position: center;
      "
    >
      {% if error %}
      <div
        class="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md z-50"
      >
        {{ error }}
      </div>
      {% endif %}

      <div id="loading-spinner" class="spinner-container">
        <div class="spinner"></div>
      </div>

      <div
        class="flex justify-center items-center"
        style="padding-top: 75px; height: calc(100vh - 60px)"
      >
        <div
          class="flex w-full max-w-none p-0 gap-1 justify-center items-center"
        >
          <!-- ì™¼ìª½: í•™ìƒ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
          <div
            class="w-1/3 bg-opacity-80 rounded-xl p-2 flex flex-col items-center justify-center -ml-[250px]"
          >
            <div class="mb-6 mt-4">
              <img
                id="student-icon"
                src="{% if studentInfo.isTagged %}
                       {% if studentInfo.gender == 'female' %}
                         {{ url_for('static', filename='image/student/girl.png') }}
                       {% else %}
                         {{ url_for('static', filename='image/student/boy.png') }}
                       {% endif %}
                     {% else %}
                       {{ url_for('static', filename='image/student/blank.png') }}
                     {% endif %}"
                alt="í•™ìƒ ì•„ì´ì½˜"
                class="w-[450px] h-[450px] object-contain"
              />
            </div>

            <div class="text-center mt-4">
              <h2 class="student-name text-[3.2rem] font-bold mb-2 font-custom">
                {% if studentInfo.isTagged %} {{ studentInfo.name }}ë‹˜! {% else
                %} í•™ìƒì¦ì„ ì¸ì‹ì‹œì¼œì£¼ì„¸ìš” {% endif %}
              </h2>
              <p
                id="student-msg"
                class="student-msg text-[3.75rem] font-bold font-custom"
              >
                {% if studentInfo.isTagged %}ì‹íŒì„ ì¸ì‹í•´ì£¼ì„¸ìš”{% endif %}
              </p>
            </div>
          </div>

          <!-- ì˜¤ë¥¸ìª½: ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ í‘œì‹œ ì˜ì—­ -->
          <div
            class="w-[1280px] h-[960px] flex-none bg-white bg-opacity-80 rounded-3xl overflow-hidden shadow-md flex items-center justify-center"
          >
            <img
              src="{{ url_for('video_feed') }}"
              class="w-full h-full object-covwe"
            />
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nameEl = document.querySelector(".student-name");
        const msgEl = document.getElementById("student-msg");
        const spinnerEl = document.getElementById("loading-spinner");
        let lastPk = null;
        let detectionRunning = false;
        let name = "";
        let status = "";
        // 1) í•™ìƒì¦/NFC í´ë§
        async function pollNfc() {
          try {
            const res = await fetch("/nfc-info");
            const data = await res.json();

            status = data.status;

            if (data.isTagged && data.pk !== lastPk) {
              lastPk = data.pk;
              nameEl.textContent = data.name + "ë‹˜!";
              msgEl.textContent = "ì‹íŒì„ ì¸ì‹í•´ì£¼ì„¸ìš”";
              document.getElementById("student-icon").src =
                data.gender === "female"
                  ? '{{ url_for("static", filename="image/student/girl.png") }}'
                  : '{{ url_for("static", filename="image/student/boy.png") }}';
              name = data.name;
            } else if (!data.isTagged && lastPk !== null) {
              lastPk = null;
              nameEl.textContent = "í•™ìƒì¦ì„ ì¸ì‹ì‹œì¼œì£¼ì„¸ìš”";
              msgEl.textContent = "";
              document.getElementById("student-icon").src =
                '{{ url_for("static", filename="image/student/blank.png") }}';
            }
          } catch (e) {
            console.error("NFC poll error", e);
          }
        }

        // 2) ì‹íŒ ê²€ì¶œ ì„±ê³µ í´ë§
        async function pollDetection() {
          try {
            const res = await fetch("/detection-status");
            if (!res.ok) return;
            const { detected, processing } = await res.json();

            if (processing) {
              spinnerEl.style.visibility = "visible";
              // ì—¬ê¸°ì„œ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ - ê¸°ì¡´ í…ìŠ¤íŠ¸ ìœ ì§€
            } else {
              spinnerEl.style.visibility = "hidden";
            }

            if (detected && !detectionRunning) {
              detectionRunning = true;
              // ì¸ì‹ì™„ë£Œ í‘œì‹œ
              nameEl.innerHTML = `
              <span class="text-blue-500 mr-2 text-[3.2rem]">ğŸ³</span>ì¸ì‹ì™„ë£Œ!`;

              if (status == "ì‹ì „") {
                msgEl.textContent = "ì‹ì‚¬ ë§›ìˆê²Œ í•˜ì„¸ìš”!";
              } else {
                msgEl.textContent = "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!";
              }

              // 3ì´ˆ ë’¤ ë³µì›
              setTimeout(() => {
                detectionRunning = false;
                if (lastPk) {
                  nameEl.textContent = name + "ë‹˜!";
                  msgEl.textContent = "ì‹íŒì„ ì¸ì‹í•´ì£¼ì„¸ìš”";
                } else {
                  nameEl.textContent = "í•™ìƒì¦ì„ ì¸ì‹ì‹œì¼œì£¼ì„¸ìš”";
                  msgEl.textContent = "";
                }
              }, 3000);
            }
          } catch (e) {
            console.error("Detection poll error", e);
          }
        }

        // ê° í´ë§ ì‹œì‘
        pollNfc();
        setInterval(pollNfc, 1000);

        pollDetection();
        setInterval(pollDetection, 1000);
      });
    </script>
  </body>
</html>
